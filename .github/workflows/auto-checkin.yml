name: Claude Code Session Reset Scheduler

# Claude Code Session Reset Scheduler - Optimized for work periods
# Based on ADR-001, ADR-002 & ADR-003: Session reset scheduling with timing optimization and Q&A health check
# 05:23 UTC+8 -> 21:23 UTC (previous day) -> Reset at 10:23 UTC+8 (morning work period)
# 10:23 UTC+8 -> 02:23 UTC -> Reset at 15:23 UTC+8 (afternoon work period)
# 17:23 UTC+8 -> 09:23 UTC -> Reset at 22:23 UTC+8 (evening work period)
# 22:23 UTC+8 -> 14:23 UTC -> Reset at 03:23 UTC+8 next day (additional coverage)
on:
  schedule:
    # Execution times are in UTC, corresponding to Taipei time (UTC+8) at 05:23, 10:23, 17:23, 22:23
    - cron: '23 21,2,9,14 * * *'
  # Manual trigger for testing
  workflow_dispatch:

jobs:
  session-reset:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      id-token: write
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        # Use a token for checkout, which is required for subsequent push actions
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
        
      - name: Pull latest changes
        run: |
          # Set a rebase strategy for pull to handle potential race conditions
          git config --global pull.rebase true
          
          # Pull the latest changes from the remote repository
          git pull origin main
      
      - name: Setup Python with uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        
      - name: Execute Session Reset Logic (Token 1)
        uses: anthropics/claude-code-action@beta
        continue-on-error: true
        with:
          mode: agent
          timeout_minutes: 2
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN_1 }}
          direct_prompt: |
            1+1=? # Answer should be 2. Do not answer anything else.
      - name: Log Q&A Check (Token 1)
        run: |
          uv run --python 3.13 python src/log_qa_check.py --token "${{ secrets.CLAUDE_CODE_OAUTH_TOKEN_1 }}"

      - name: Execute Session Reset Logic (Token 2)
        uses: anthropics/claude-code-action@beta
        continue-on-error: true
        with:
          mode: agent
          timeout_minutes: 2
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN_2 }}
          direct_prompt: |
            1+1=? # Answer should be 2. Do not answer anything else.
      - name: Log Q&A Check (Token 2)
        run: |
          uv run --python 3.13 python src/log_qa_check.py --token "${{ secrets.CLAUDE_CODE_OAUTH_TOKEN_2 }}"
            
      - name: Commit and Push changes
        run: |
          # Add all modified CSV files to the staging area
          git add logs/*.csv
          
          # Check if there are any actual file changes. If so, commit and push.
          if ! git diff-index --quiet HEAD; then
            echo "Changes detected. Committing and pushing..."
            TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            git commit -m "chore(bot): Session reset trigger at $TIMESTAMP"
            # Push the changes
            git push origin main
          else
            echo "No changes to commit. Working tree clean."
          fi